<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">
    <title>xhr-simple-request test</title>
    <script src="../../webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="server.js"></script>
    <link rel="import" href="../xhr-simple-request.html">
  </head>
  <body>

    <test-fixture id="Basic">
      <template>
        <xhr-simple-request></xhr-simple-request>
      </template>
    </test-fixture>

    <script>
      suite('xhr-simple-request', () => {
        let lastId = 0;
        function fire(detail) {
          detail.id = 'request' + (++lastId);
          const e = new CustomEvent('api-request', {
            cancelable: true,
            bubbles: true,
            composed: true,
            detail: detail
          });
          document.body.dispatchEvent(e);
        }

        suite('Success requests', () => {
          suiteSetup(function() {
            window.mockServer.createServer();
          });
          suiteTeardown(function() {
            window.mockServer.restore();
          });
          const APIROOT = 'http://success.domain.com/';
          let element;
          setup(() => {
            element = fixture('Basic');
          });

          test('Response contains all properties', (done) => {
            const request = {
              url: APIROOT,
              method: 'GET'
            };
            fire(request);
            element.addEventListener('api-response', function clb(e) {
              element.removeEventListener('api-response', clb);
              const data = e.detail;
              assert.isFalse(data.isError, 'isError is set');
              assert.typeOf(data.loadingTime, 'number', 'loadingTime is set');
              assert.isTrue(data.request === request, 'passes request object');
              assert.typeOf(data.response, 'object', 'response is set');
              assert.isUndefined(data.error, 'error is undefined');
              assert.equal(data.id, 'request' + lastId, 'id is set');
              done();
            });
          });

          test('Response object contains response', (done) => {
            const request = {
              url: APIROOT,
              method: 'GET'
            };
            fire(request);
            element.addEventListener('api-response', function clb(e) {
              element.removeEventListener('api-response', clb);
              const data = e.detail.response;
              assert.equal(data.status, 200, 'status is set');
              assert.equal(data.statusText, 'OK', 'statusText is set');
              assert.typeOf(data.headers, 'string', 'headers is set');
              assert.typeOf(data.payload, 'string', 'payload is set');
              done();
            });
          });

          test('Reports JSON response', (done) => {
            const request = {
              url: APIROOT + 'json',
              method: 'GET'
            };
            fire(request);
            element.addEventListener('api-response', function clb(e) {
              element.removeEventListener('api-response', clb);
              const data = e.detail.response;
              assert.equal(data.status, 200, 'status is set');
              assert.equal(data.statusText, 'OK', 'statusText is set');
              assert.typeOf(data.headers, 'string', 'headers is set');
              assert.equal(data.payload, '{"test":true}', 'payload is set');
              done();
            });
          });

          test('Reports XML response', (done) => {
            const request = {
              url: APIROOT + 'xml',
              method: 'GET'
            };
            fire(request);
            element.addEventListener('api-response', function clb(e) {
              element.removeEventListener('api-response', clb);
              const data = e.detail.response;
              assert.equal(data.status, 200, 'status is set');
              assert.equal(data.statusText, 'OK', 'statusText is set');
              assert.typeOf(data.headers, 'string', 'headers is set');
              assert.equal(data.payload, '<test></test>', 'payload is set');
              done();
            });
          });

          test('Sends data with request', (done) => {
            const body = 'test-payload';
            const request = {
              url: APIROOT + 'post',
              method: 'POST',
              payload: body,
              headers: 'Content-Type: plain/text'
            };
            fire(request);
            element.addEventListener('api-response', function clb(e) {
              element.removeEventListener('api-response', clb);
              const data = e.detail.response;
              assert.equal(data.payload, body, 'payload is set');
              done();
            });
          });

          test('Sends headers with request', (done) => {
            const request = {
              url: APIROOT + 'headers',
              method: 'GET',
              headers: 'x-test: test\r\naccept: application/json'
            };
            fire(request);
            window.addEventListener('api-response', function clb(e) {
              window.removeEventListener('api-response', clb);
              const data = e.detail.response;
              assert.equal(data.payload, '{"x-test":"test","accept":"application/json"}', 'headers is set');
              done();
            });
          });
        });

        // suite('Error requests - echo.advancedrestclient.com', () => {
        //   const APIROOT = 'https://echo.advancedrestclient.com/status/';
        //   let element;
        //   setup(() => {
        //     element = fixture('Basic');
        //   });
        //
        //   test('Response contains all properties', (done) => {
        //     const request = {
        //       url: APIROOT + '404',
        //       method: 'GET'
        //     };
        //     fire(request);
        //     window.addEventListener('api-response', function clb(e) {
        //       window.removeEventListener('api-response', clb);
        //       const data = e.detail;
        //       assert.isTrue(data.isError, 'isError is set');
        //       assert.typeOf(data.loadingTime, 'number','loadingTime is set');
        //       assert.isTrue(data.request === request, 'passes request object');
        //       assert.typeOf(data.response, 'object','response is set');
        //       assert.typeOf(data.error, 'error', 'error is set');
        //       assert.equal(data.id, 'request' + lastId, 'id is set');
        //       done();
        //     });
        //   });
        //
        //   test('Response object contains response', (done) => {
        //     const request = {
        //       url: APIROOT + '404',
        //       method: 'GET'
        //     };
        //     fire(request);
        //     window.addEventListener('api-response', function clb(e) {
        //       window.removeEventListener('api-response', clb);
        //       const data = e.detail.response;
        //       assert.equal(data.status, 404, 'status is set');
        //       assert.equal(data.statusText, 'Not Found', 'statusText is set');
        //       assert.typeOf(data.headers, 'string', 'headers is set');
        //       assert.typeOf(data.payload, 'string', 'payload is set');
        //       done();
        //     });
        //   });
        // });

        // suite('Success requests - echo.advancedrestclient.com', () => {
        //   const APIROOT = 'https://echo.advancedrestclient.com/';
        //   let element;
        //   setup(() => {
        //     element = fixture('Basic');
        //   });
        //
        //   test('Response contains all properties', (done) => {
        //     const request = {
        //       url: APIROOT + 'get',
        //       method: 'GET'
        //     };
        //     fire(request);
        //     window.addEventListener('api-response', function clb(e) {
        //       window.removeEventListener('api-response', clb);
        //       const data = e.detail;
        //       assert.isFalse(data.isError, 'isError is set');
        //       assert.typeOf(data.loadingTime, 'number','loadingTime is set');
        //       assert.isTrue(data.request === request, 'passes request object');
        //       assert.typeOf(data.response, 'object','response is set');
        //       assert.isUndefined(data.error, 'error is undefined');
        //       assert.equal(data.id, 'request' + lastId, 'id is set');
        //       done();
        //     });
        //   });
        //
        //   test('Response object contains response', (done) => {
        //     const request = {
        //       url: APIROOT + 'get',
        //       method: 'GET'
        //     };
        //     fire(request);
        //     window.addEventListener('api-response', function clb(e) {
        //       window.removeEventListener('api-response', clb);
        //       const data = e.detail.response;
        //       assert.equal(data.status, 200, 'status is set');
        //       assert.equal(data.statusText, 'OK', 'statusText is set');
        //       assert.typeOf(data.headers, 'string', 'headers is set');
        //       assert.typeOf(data.payload, 'string', 'payload is set');
        //       done();
        //     });
        //   });
        //
        //   test('Reports JSON response', (done) => {
        //     const request = {
        //       url: APIROOT  + 'get',
        //       method: 'GET'
        //     };
        //     fire(request);
        //     window.addEventListener('api-response', function clb(e) {
        //       window.removeEventListener('api-response', clb);
        //       const data = e.detail.response;
        //       assert.equal(data.status, 200, 'status is set');
        //       assert.equal(data.statusText, 'OK', 'statusText is set');
        //       assert.typeOf(data.headers, 'string', 'headers is set');
        //       JSON.parse(data.payload);
        //       done();
        //     });
        //   });
        //
        //   test('Sends data with request', (done) => {
        //     const body = 'test-payload';
        //     const request = {
        //       url: APIROOT + 'post',
        //       method: 'POST',
        //       payload: body,
        //       headers: 'Content-Type: plain/text'
        //     };
        //     fire(request);
        //     window.addEventListener('api-response', function clb(e) {
        //       window.removeEventListener('api-response', clb);
        //       const data = JSON.parse(e.detail.response.payload);
        //       assert.equal(data.body, body, 'payload is set');
        //       done();
        //     });
        //   });
        //
        //   test('Sends headers with request', (done) => {
        //     const request = {
        //       url: APIROOT + 'get',
        //       method: 'GET',
        //       headers: 'x-test: test\r\naccept: application/json'
        //     };
        //     fire(request);
        //     window.addEventListener('api-response', function clb(e) {
        //       window.removeEventListener('api-response', clb);
        //       const data = JSON.parse(e.detail.response.payload);
        //       const headers = data.headers;
        //       assert.equal(headers['x-test'], 'test', 'x-test is set');
        //       assert.equal(headers.accept, 'application/json', 'accept is set');
        //       done();
        //     });
        //   });
        // });
      });
    </script>
  </body>
</html>
